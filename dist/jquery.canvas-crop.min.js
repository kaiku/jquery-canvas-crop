/*! jquery.canvas-crop %> */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){var b,c,d,e;b=function(c,d){var e=window.getComputedStyle(c,null);this.canvas=c,this.$canvas=a(c),this.$window=a(window),this.options=a.extend({},b.DEFAULTS,d),this.context=c.getContext("2d"),this.image=null,this.marquee=null,this.state={canvas:{paddingLeft:parseInt(e.getPropertyValue("padding-left")),paddingTop:parseInt(e.getPropertyValue("padding-top")),borderTop:parseInt(e.getPropertyValue("border-top-width")),borderLeft:parseInt(e.getPropertyValue("border-left-width"))},repositioning:!1,repositioningCoords:{x:null,y:null},repositioningOffset:{x:null,y:null},resizing:!1,resizingCoords:{x:null,y:null},shiftKey:!1},this.init()},b.DEFAULTS={marqueeType:"rectangle",constrain:!0,src:"",enableRawDataOutput:!1},b.prototype.init=function(){var b=this;this.$canvas.on("mousedown",a.proxy(this.handleMousedown,this)).on("mousemove",a.proxy(this.handleMousemove,this)).css("cursor","crosshair"),this.$window.on("mouseup",a.proxy(this.handleMouseup,this)).on("keyup keydown",function(a){return b.state.shiftKey=a.shiftKey,!0}),this.drawBackground()},b.prototype.handleMousedown=function(a){var b=this.getMouse(a),c=this.state;this.marquee&&this.marquee.contains(b.x,b.y)?(c.repositioning=!0,c.resizing=!1,c.repositioningOffset.x=b.x-this.marquee.x,c.repositioningOffset.y=b.y-this.marquee.y):(c.repositioning=!1,c.resizing=!0)},b.prototype.handleMouseup=function(){(this.state.repositioning||this.state.resizing)&&(this.$canvas.trigger(a.Event("crop.finish",{coordinates:this.getCropCoordinates(!0)})),this.options.enableRawDataOutput&&this.$canvas.trigger(a.Event("crop.data",{rawData:this.getRawCroppedImageData()}))),this.state.repositioning=!1,this.state.resizing=!1},b.prototype.handleMousemove=function(a){var b=this.state,c=this.getMouse(a);return this.marquee&&(this.marquee.contains(c.x,c.y)?this.$canvas.css("cursor","move"):this.$canvas.css("cursor","crosshair")),b.repositioning||b.resizing?(this.clearCanvas(),b.repositioning?this.repositionMarquee(a):b.resizing?this.resizeMarquee(a):void 0):(b.resizingCoords.x=null,void(b.resizingCoords.y=null))},b.prototype.repositionMarquee=function(b){var c,d,e=this.getMouse(b),f=this.state,g=this.getScaledDimensions(),h=this.marquee;c=e.x-f.repositioningOffset.x,d=e.y-f.repositioningOffset.y,c=Math.min(Math.max(c,g.x),g.x2-h.w),d=Math.min(Math.max(d,g.y),g.y2-h.h),this.drawMarquee(c,d,h.w,h.h),this.$canvas.trigger(a.Event("crop.reposition",{coordinates:this.getCropCoordinates(!0)}))},b.prototype.resizeMarquee=function(b){var c,d,e,f,g=this.getMouse(b),h=this.state,i=this.getScaledDimensions();if(h.resizingCoords.x&&h.resizingCoords.y||(h.resizingCoords=g,h.repositioningCoords=g),c=Math.min(Math.max(h.resizingCoords.x,i.x),i.x2),d=Math.min(Math.max(h.resizingCoords.y,i.y),i.y2),e=g.x<c?Math.max(g.x-c,i.x-c):Math.min(Math.max(g.x-c,0),i.x2-c),f=g.y<d?Math.max(g.y-d,i.y-d):Math.min(Math.max(g.y-d,0),i.y2-d),this.options.constrain||this.state.shiftKey){var j=Math.min(Math.abs(e),Math.abs(f));f=0>f?-j:j,e=0>e?-j:j}this.drawMarquee(c,d,e,f),this.$canvas.trigger(a.Event("crop.resize",{coordinates:this.getCropCoordinates(!0)}))},b.prototype.drawMarquee=function(a,b,c,f){var g;switch(this.options.marqueeType){case"rectangle":g=new d(a,b,c,f);break;case"ellipse":g=new e(a,b,c,f);break;default:return}g.draw(this.context),this.marquee=g},b.prototype.getCropCoordinates=function(a){var b,c,d=this.getScalingFactor();if(!this.marquee)return null;if(b=this.getScaledDimensions(),c={x:(this.marquee.x-b.x)/d,y:(this.marquee.y-b.y)/d,w:this.marquee.w/d,h:this.marquee.h/d},a)for(var e in c)c.hasOwnProperty(e)&&(c[e]=Math.floor(c[e]));return c},b.prototype.drawBackground=function(){this.options.src&&!this.image?(this.image=document.createElement("img"),this.image.src=this.options.src,a(this.image).on("load",this.drawImage.bind(this))):this.drawImage()},b.prototype.drawImage=function(){var a=this.getScaledDimensions();this.context.drawImage(this.image,a.x,a.y,a.w,a.h)},b.prototype.clearCanvas=function(){this.context.clearRect(0,0,this.getCanvasWidth(),this.getCanvasHeight()),this.drawBackground()},b.prototype.getScaledDimensions=function(){var a=this.getScalingFactor(),b=this.image.width*a,c=this.image.height*a,d=(this.getCanvasWidth()-b)/2,e=(this.getCanvasHeight()-c)/2;return{x:d,y:e,x2:d+b,y2:e+c,w:b,h:c}},b.prototype.getScalingFactor=function(){var a=this.getCanvasWidth()/this.image.width,b=this.getCanvasHeight()/this.image.height;return Math.min(Math.min(a,b),1)},b.prototype.getCanvasWidth=function(){return this.canvas.width},b.prototype.getCanvasHeight=function(){return this.canvas.height},b.prototype.getMouse=function(b){var c=b.target,d=a(c).offset();return{x:b.pageX-d.left-this.state.canvas.paddingLeft-this.state.canvas.borderLeft,y:b.pageY-d.top-this.state.canvas.paddingTop-this.state.canvas.borderTop}},b.prototype.getRawCroppedImageData=function(){var a,b=document.createElement("canvas"),c=b.getContext("2d"),d=this.getCropCoordinates(!0);a={x:d.x,y:d.y,w:d.w,h:d.h,image:{w:this.image.width,h:this.image.height}},b.width=d.w,b.height=d.h,c.drawImage(this.image,d.x,d.y,d.w,d.h,0,0,d.w,d.h);try{a.data=b.toDataURL("image/png")}catch(e){a.data=null,a.exception=e}return a},c=function(a,b,c,d,e){this.x=a,this.y=b,this.w=c,this.h=d,this.fill=e||"rgba(0, 255, 255, .3)",this.normalize()},c.prototype.normalize=function(){this.x=this.w<0?this.x+this.w:this.x,this.y=this.h<0?this.y+this.h:this.y,this.w=Math.abs(this.w),this.h=Math.abs(this.h)},c.prototype.draw=function(){throw'Method "draw" must be implemented on objects inheriting from Shape.'},c.prototype.contains=function(){throw'Method "contains" must be implemented on objects inheriting from Shape.'},d=function(a,b,d,e,f){c.call(this,a,b,d,e,f)},a.extend(d.prototype,c.prototype),d.prototype.draw=function(a){a.fillStyle=this.fill,a.fillRect(this.x,this.y,this.w,this.h)},d.prototype.contains=function(a,b){return this.x<=a&&this.x+this.w>=a&&this.y<=b&&this.y+this.h>=b},e=function(a,b,d,e,f){c.call(this,a,b,d,e,f),this.kappa=.5522848,this.ox=this.w/2*this.kappa,this.oy=this.h/2*this.kappa,this.xe=this.x+this.w,this.ye=this.y+this.h,this.xm=this.x+this.w/2,this.ym=this.y+this.h/2,this.xr=this.w/2,this.yr=this.h/2},a.extend(e.prototype,c.prototype),e.prototype.contains=function(a,b){return Math.pow(a-this.xm,2)/Math.pow(this.xr,2)+Math.pow(b-this.ym,2)/Math.pow(this.yr,2)<=1},e.prototype.draw=function(a){var b=this.x,c=this.y,d=this.ox,e=this.oy,f=this.xe,g=this.ye,h=this.xm,i=this.ym;a.beginPath(),a.moveTo(b,i),a.bezierCurveTo(b,i-e,h-d,c,h,c),a.bezierCurveTo(h+d,c,f,i-e,f,i),a.bezierCurveTo(f,i+e,h+d,g,h,g),a.bezierCurveTo(h-d,g,b,i+e,b,i),a.closePath(),a.fillStyle=this.fill,a.fill()},a.fn.canvasCrop=function(c){return this.each(function(){var d=a(this),e=d.data("canvas-crop"),f=a.extend({},b.DEFAULTS,d.data(),"object"==typeof c&&c);e||d.data("canvas-crop",e=new b(this,f))})},a.fn.canvasCrop.Constructor=b});